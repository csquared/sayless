#!/bin/bash

# Script to sync music files from c2storage to SAYLESS-2TB
# Uses inclusion-based sync (music files only)

# Get script directory for includes file
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INCLUDES_FILE="$SCRIPT_DIR/rsync-music-includes.txt"

SOURCE_DJ="/Volumes/c2storage/DJ/"
SOURCE_PRODUCTION="/Volumes/c2storage/Production/"
DEST_DJ="/Volumes/SAYLESS-2TB/DJ/"
DEST_PRODUCTION="/Volumes/SAYLESS-2TB/Production/"

# Check if volumes are mounted
if [ ! -d "/Volumes/c2storage" ]; then
    echo "Warning: Source volume not found at /Volumes/c2storage"
    echo "Skipping external drive sync."
    exit 0
fi

if [ ! -d "/Volumes/SAYLESS-2TB" ]; then
    echo "Warning: Destination volume not found at /Volumes/SAYLESS-2TB"
    echo "Skipping external drive sync (mount SAYLESS-2TB to enable)."
    exit 0
fi

# Display what will be synced
echo "=== RSYNC Music Sync ==="
echo "Syncing DJ and Production directories"
echo "Source: /Volumes/c2storage/{DJ,Production}"
echo "Destination: /Volumes/SAYLESS-2TB/{DJ,Production}"
echo ""
echo "Using inclusion-based sync (music files only)..."
echo ""

# Check for dry-run flag
DRY_RUN=""
if [ "$1" == "--dry-run" ] || [ "$1" == "-n" ]; then
    DRY_RUN="--dry-run"
    echo "*** DRY RUN MODE - No files will be copied ***"
    echo ""
fi

# Run rsync for DJ directory
echo "Syncing DJ directory..."
echo ""

if [ -d "$SOURCE_DJ" ]; then
    rsync -av \
        --progress \
        --delete-after \
        --backup \
        --backup-dir=/Volumes/SAYLESS-2TB/.rsync-backup \
        --exclude='._*' \
        --exclude='.DS_Store' \
        --exclude='.*' \
        --include-from="$INCLUDES_FILE" \
        --exclude='*' \
        $DRY_RUN \
        "$SOURCE_DJ" "$DEST_DJ"
else
    echo "DJ directory not found, skipping..."
fi

echo ""
echo "Syncing Production directory..."
echo ""

if [ -d "$SOURCE_PRODUCTION" ]; then
    rsync -av \
        --progress \
        --delete-after \
        --backup \
        --backup-dir=/Volumes/SAYLESS-2TB/.rsync-backup \
        --exclude='._*' \
        --exclude='.DS_Store' \
        --exclude='.*' \
        --include-from="$INCLUDES_FILE" \
        --exclude='*' \
        $DRY_RUN \
        "$SOURCE_PRODUCTION" "$DEST_PRODUCTION"
else
    echo "Production directory not found, skipping..."
fi

echo ""
echo "=== Sync Complete ==="
