#!/usr/bin/env bash

set -e  # Exit on error

DOWNLOAD_DIR="$HOME/Downloads"
SOURCING_DIR="/Volumes/c2storage/DJ/sourcing"
PLAYLIST_SOURCING_DIR="/Volumes/c2storage/DJ/collection2/sourcing"
PLAYLIST_DIR="/Volumes/c2storage/DJ/collection2/playlists"

# Check if a file is still downloading (has a .part file)
is_downloading() {
    local filename="$1"
    local ext="$2"
    local base="${filename%.$ext}"

    # Check for any .part files matching this file
    if ls "$base".*."$ext".part 2>/dev/null | grep -q .; then
        return 0  # true, is downloading
    fi
    return 1  # false, not downloading
}

# Move file to sourcing directory with filename transliteration
move_file_to_sourcing_dir() {
    local filepath="$1"
    local base_filename=$(basename "$filepath")

    # Transliterate UTF-8 to ASCII using iconv, then clean up with sed
    # //TRANSLIT converts accented chars (é→'e, ñ→~n)
    # //IGNORE skips unconvertible chars
    # Then sed removes quotes, tildes, and other artifacts
    local new_filename=$(echo "$base_filename" | \
        iconv -f UTF-8 -t ASCII//TRANSLIT//IGNORE 2>/dev/null | \
        sed "s/'//g; s/\`//g; s/~//g; s/\"//g")

    echo "$base_filename"
    echo "$new_filename"

    mv "$filepath" "$SOURCING_DIR/$new_filename"
}

# Generate M3U8 playlist from sourcing directory
generate_playlist() {
    local playlist_path="$PLAYLIST_DIR/sourcing.m3u8"

    # Create playlist file with header
    echo '#EXTM3U' > "$playlist_path"

    # Add all audio files, sorted (-L follows symlinks, exclude ._ files)
    find -L "$PLAYLIST_SOURCING_DIR" -type f \( -name "*.mp3" -o -name "*.aiff" -o -name "*.wav" -o -name "*.aif" -o -name "*.flac" \) ! -name '._*' | sort >> "$playlist_path"

    echo "Playlist updated: $playlist_path"
}

# Process audio files in Downloads
for ext in mp3 aiff aif wav; do
    for filepath in "$DOWNLOAD_DIR"/*."$ext"; do
        # Skip if glob didn't match anything
        [ -e "$filepath" ] || continue

        filename=$(basename "$filepath")
        echo "$ext found: $filename"

        if is_downloading "$filepath" "$ext"; then
            echo "still downloading"
        else
            move_file_to_sourcing_dir "$filepath"
            echo "...moved"
        fi
    done
done

generate_playlist
echo "generated playlist"

# Sync to Hetzner
echo ""
echo "Syncing to Hetzner..."
if sync-to-hetzner; then
    echo "Successfully synced to Hetzner!"
else
    echo "Warning: Sync to Hetzner failed. You may need to run sync-to-hetzner manually."
fi

# Sync to external drive backup
echo ""
echo "Syncing to external drive backup..."
if sync-music; then
    echo "Successfully synced to external drive!"
else
    echo "External drive sync skipped or unavailable."
fi
